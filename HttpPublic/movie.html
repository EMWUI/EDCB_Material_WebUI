require('lfs')
dofile(mg.document_root..'\\api\\util.lua')
dofile(mg.script_name:gsub('[^\\/]*$','')..'string.lua')
dofile(mg.script_name:gsub('[^\\/]*$','')..'util.lua')

MoviePath=0+edcb.GetPrivateProfile('SET','MoviePath',0,path)~=0 and path or 'Common.ini'
ViewMode=0+edcb.GetPrivateProfile('SET','ViewMode',1,path)~=0

ct={title='ホーム', video=true}

ct.css='<style>.view-'..(ViewMode and 'grid' or 'list')..'{display:none;}</style>'
ct.js='<script>\nViewMode='..(ViewMode and 'true' or 'false')..';$(function(){checkMovieList();});\n</script>\n'

ct.Scrollable=true
ct.subheader=[=[
<div class="path mdl-layout__tab-bar">
<span class="mdl-layout__tab is-active" data-id="home">ホーム</span>
</div>
]=]

ct.menu=[=[
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu" for="menu">
<li class="view-grid mdl-menu__item mdl-menu__item--full-bleed-divider" onclick="toggleView(true);"><i class="material-icons">view_module</i>グリッド表示</li>
<li class="view-list mdl-menu__item mdl-menu__item--full-bleed-divider" onclick="toggleView(false);"><i class="material-icons">view_list</i>リスト表示</li>
<li class="mdl-menu__item" onclick="refreshMovieList();"><i class="material-icons">refresh</i>再読み込み</li>
<li class="mdl-menu__item" disabled><i class="material-icons">photo</i>サムネ作成</li>
</ul>
]=]

ctt={'<main class="mdl-layout__content">\n'
  ..'<div id="movielist" class="'..(ViewMode and 'list ' or '')..'mdl-grid">\n'
  ..(ViewMode and '' or '<ul class="main-content mdl-list mdl-cell mdl-cell--12-col mdl-shadow--4dp">\n')
}

count=0+edcb.GetPrivateProfile('SET','RecFolderNum',0,MoviePath)-1
for i=0,count do
  dir=edcb.GetPrivateProfile('SET','RecFolderPath'..i,'',MoviePath)
  Public=NativeToDocumentPath(dir)
  if #dir>0 then
    if ViewMode then
      table.insert(ctt, '<div class="folder mdl-card mdl-js-button mdl-js-ripple-effect mdl-cell mdl-cell--2-col mdl-shadow--2dp" data-id="'..(Public or dir)..'"><div class="mdl-card__title mdl-card--expand"><i class="material-icons">folder</i></div><div class="mdl-card__actions"><span class="filename">'..(Public or dir)..'</span></div></div>\n')
    else
      table.insert(ctt, '<li class="folder mdl-list__item" data-id="'..(Public or dir)..'"><span class="mdl-list__item-primary-content"><i class="material-icons mdl-list__item-avatar mdl-color--primary">folder</i><span>'..(Public or dir)..'</span></span></li>\n')
    end
  end
end

ct.main=table.concat(ctt)..(ViewMode and '' or '</ul>\n')..'</div>\n'

ct=template(ct)

mg.write('HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: '..#ct..(mg.keep_alive(true) and '' or '\r\nConnection: close')..'\r\n\r\n', ct)
