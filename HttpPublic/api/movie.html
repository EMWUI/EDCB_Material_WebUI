require('lfs')
dofile(mg.script_name:gsub('[^\\/]*$','')..'string.lua')
dofile(mg.script_name:gsub('[^\\/]*$','')..'util.lua')

RecFolder=0+edcb.GetPrivateProfile('SET','RecFolder',0,path)~=0 and path or 'Common.ini'
grid=0+edcb.GetPrivateProfile('SET','grid',1,path)~=0

ct={title='ホーム', video=true}

ct.js='<script>\nlist='..(grid and 'false' or 'true')..';$(function(){checkmovielist();});\n</script>\n'

ct.Scrollable=true
ct.subheader=[=[
<div class="path mdl-layout__tab-bar">
<span class="mdl-layout__tab is-active" data-id="home">ホーム</span>
</div>
]=]

ct.menu=[=[
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu" for="menu">
<li class="epg mdl-menu__item" onclick="list=false;folder($('.mdl-layout__tab.is-active').data('id'));"><i class="material-icons">view_module</i>グリッド表示</li>
<li class="epg mdl-menu__item" onclick="list=true;folder($('.mdl-layout__tab.is-active').data('id'));"><i class="material-icons">view_list</i>リスト表示</li>
<li class="epg mdl-menu__item" onclick="getmovielist(true);"><i class="material-icons">refresh</i>再読み込み</li>
<li class="epg mdl-menu__item" disabled><i class="material-icons">photo</i>サムネ作成</li>
</ul>
]=]

ctt={'<main class="mdl-layout__content">\n'}

if grid then
  table.insert(ctt, '<div class="list mdl-grid">\n')
else 
  table.insert(ctt, '<div class="mdl-grid">\n<ul class="main-content mdl-list mdl-cell mdl-cell--12-col mdl-shadow--4dp">\n')
end

count=0+edcb.GetPrivateProfile('SET','RecFolderNum',0,RecFolder)-1
for i=0,count do
  dir=edcb.GetPrivateProfile('SET','RecFolderPath'..i,'',RecFolder)
  if dir ~= '' then
    if grid then
      table.insert(ctt, '<div class="folder mdl-card mdl-cell mdl-cell--2-col mdl-shadow--2dp" data-id="'..dir..'"><div class="mdl-card__title mdl-card--expand"><i class="material-icons">folder</i></div><div class="mdl-card__actions"><span class="filename">'..dir..'</span></div></div>\n')
    else
      table.insert(ctt, '<li class="folder mdl-list__item" data-id="'..dir..'"><span class="mdl-list__item-primary-content"><i class="material-icons mdl-list__item-avatar mdl-color--primary">folder</i><span>'..dir..'</span></span></li>\n')
    end
  end
end

ct.main=table.concat(ctt)..(grid and '' or '</ul>\n')..'</div>\n'

ct=template(ct)

mg.write('HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: '..#ct..(mg.keep_alive(true) and '' or '\r\nConnection: close')..'\r\n\r\n', ct)
