dofile(mg.script_name:gsub('[^\\/]*$','')..'string.lua')
dofile(mg.script_name:gsub('[^\\/]*$','')..'util.lua')

root=mg.script_name:gsub('[^\\/]*$',''):gsub(mg.document_root..'/',''):gsub('[^\\/]*[\\/]','../')

ct={title='録画結果'}

page=0+(mg.get_var(mg.request_info.query_string,'page') or 0)

edcb.htmlEscape=15
v=edcb.GetRecFileInfo(0+(mg.get_var(mg.request_info.query_string,'id') or 0))
if v then
  -- トランスコード済みのファイルがvideoフォルダにあればそっち使う
  ori=nil
  fname=string.match(v.recFilePath, '([^\\]+%.)[^%.]+$')
  f=io.open(edcb.Convert('cp932', 'utf-8', mg.script_name:gsub('[^\\/]*$','')..'video\\'..fname..'webm'), 'rb') or
    io.open(edcb.Convert('cp932', 'utf-8', mg.script_name:gsub('[^\\/]*$','')..'video\\'..fname..'mp4'), 'rb')
  fname='video/'..mg.url_encode(fname)
  if not f then
      f=io.open(edcb.Convert('cp932', 'utf-8', v.recFilePath), 'rb')
      ori=true
  end
  if f then
    f:close()
  end

  title=ConvertTitle(v.title)
  w=os.date('%w', os.time(v.startTime))

  info=v.programInfo:gsub('(.-)'..string.gsub(v.title, '%[(.-)%]', '%%[%1%%]')..'\r?\n\r?\n', '')
    :gsub('\r?\n', '<br>\n')
    :gsub('<div>\n<br>\n</div>', '')
    :gsub('<br>\n<br>\n<br>', '')
    :gsub('ジャンル : <br>\n', '</div>\n<ul>\n<li>結果<ul><li>'..v.comment..'</li></ul></li>\n<li>ドロップ '..v.drops..'</li>\n<li>スクランブル '..v.scrambles..'</li>\n<li>ジャンル<ul><li>')
    :gsub('<br>\n<br>\n映像 : ', '</li></ul></li>\n<li>映像<ul><li>')
    :gsub('<br>\n音声 : ', '</li></ul></li>\n<li>音声<ul><li>')
    :gsub('kHz<br>\n<br>\n', 'kHz\n</li></ul></li>\n<li>その他<ul><li>')
    :gsub('放送<br>\n<br>\n', '放送<br>\n')

  info=string.find(info, "詳細情報") and info:gsub('\n<br>\n詳細情報<br>', '</p>\n</div>\n<div><section class="mdl-layout__tab-panel is-active" id="detail">\n<div class="mdl-typography--body-1">')
                                             :gsub('\n詳細情報<br>', '</p>\n</div>\n<div><section class="mdl-layout__tab-panel is-active" id="detail">\n<div class="mdl-typography--body-1">')
                                      or info:gsub('<br>\n</div>\n<ul>', '</p>\n</div>\n<div><section class="mdl-layout__tab-panel is-active" id="detail">\n<ul>')

  info=(#info>0 and '<p>'..info..'</li></ul></li>\n' or '</div>\n<div><section class="mdl-layout__tab-panel is-active" id="detail">\n<ul><li>結果<ul><li>'..v.comment..'</li></ul></li>')..'</ul>'

  ct.main='<main class="mdl-layout__content">\n'
    ..'<div class="mdl-grid">\n<div class="main-content mdl-cell mdl-cell--12-col mdl-shadow--4dp">'
    ..'<div>\n<h4 class="mdl-typography--title">'..title..'\n<span class="mdl-typography--subhead mdl-grid mdl-grid--no-spacing">'..(v.startTime and os.date('<span class="date">%Y/%m/%d('..({'日','月','火','水','木','金','土'})[w+1]..') %H:%M-', os.time(v.startTime))
    ..(v.durationSecond and os.date('%H:%M', os.time(v.startTime)+v.durationSecond) or '未定') or '未定')..'</span>'
    ..'<span class="service">'..v.serviceName..'</span></span></h4>\n'..info:gsub('https?://[%w/:%#%$&%?%(%)~%.=%+%-_]+', '<a href="%1" target="_blank">%1</a>')..'</section>\n'

    ..(f and '<section class="mdl-layout__tab-panel" id="movie">\n<div class="mdl-grid mdl-grid--no-spacing"><div>\n'
           ..'<video'..(ori and ' preload="none"' or '')..' controls>\n<source src="'..fname..'mp4" type="video/mp4">\n<source src="'..fname..'webm" type="video/webm">\n<source src="'..root..'api/Movie?id='..v.id..'" type="video/webm" data-load="'..(ori and 'false' or 'true')..'">\n</video>\n'
           ..'</div></div>\n</section>\n' or '')

    ..(#v.errInfo>0 and '<section class="mdl-layout__tab-panel" id="error">\n<div>\n<pre>'..v.errInfo..'</pre>\n</div>\n</section>\n' or '')
    ..'</div>\n'

    ..'<div class="mdl-dialog__actions mdl-card__actions mdl-card--border">\n'
    ..'<form id="del" method="POST" action="'..root..'api/RecInfoDel?id='..v.id..'" data-redirect="recinfo.html'..(page~=0 and '?page='..page or '')..'"></form>\n'
    ..'<button class="submit mdl-button mdl-js-button mdl-button--primary" data-form="#del">削除</button>\n'
    ..'</div>\n'

    ..'</div></div>\n'

end


ct.tab='<a href="#detail" class="mdl-layout__tab is-active">番組詳細</a>\n'
     ..(f and '<a href="#movie" class="play mdl-layout__tab">再生</a>\n' or '')
     ..(#v.errInfo>0 and '<a href="#error" class="mdl-layout__tab">エラーログ</a>\n' or '')

ct=template(ct)

mg.write('HTTP/1.1 200 OK\r\nContent-Type: text/html\r\nContent-Length: '..#ct..(mg.keep_alive(true) and '' or '\r\nConnection: close')..'\r\n\r\n', ct)
